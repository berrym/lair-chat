#!/usr/bin/expect -f
set timeout 10

puts "ğŸ” Debug Test - Simple Connection"
puts "================================"

spawn ./target/release/lair-chat-client
puts "âœ… Client spawned"

expect {
    "Welcome to Lair Chat!" {
        puts "âœ… Got welcome message"
    }
    timeout {
        puts "âŒ No welcome message - timeout"
        exit 1
    }
    eof {
        puts "âŒ Client died unexpectedly"
        exit 1
    }
}

expect {
    "Login with existing account? (y/n):" {
        puts "âœ… Got login prompt"
        send "n\r"
    }
    timeout {
        puts "âŒ No login prompt - timeout"
        exit 1
    }
}

expect {
    "Enter username:" {
        puts "âœ… Got username prompt"
        send "testuser\r"
    }
    timeout {
        puts "âŒ No username prompt - timeout"
        exit 1
    }
}

expect {
    "Enter password:" {
        puts "âœ… Got password prompt"
        send "testpass\r"
    }
    timeout {
        puts "âŒ No password prompt - timeout"
        exit 1
    }
}

puts "â³ Waiting for authentication..."

expect {
    "Registration successful" {
        puts "âœ… Registration successful"
    }
    "Authentication successful" {
        puts "âœ… Authentication successful"
    }
    timeout {
        puts "âŒ Authentication failed - timeout"
        exit 1
    }
    eof {
        puts "âŒ Connection died during auth"
        exit 1
    }
}

puts "â³ Waiting for lobby setup..."
sleep 3

puts "ğŸ“ Testing simple message..."
send "Hello, testing basic functionality!\r"
sleep 2

puts "ğŸ  Testing room creation..."
send "/create-room debugroom\r"
sleep 3

puts "ğŸ‘‹ Quitting..."
send "/quit\r"

expect {
    eof {
        puts "âœ… Clean exit"
    }
    timeout {
        puts "âŒ Quit timeout"
    }
}

puts "ğŸ‰ Debug test completed!"
